# 유저 시나리오 기반 기능 정의, 요구사항 명세

## 상품 목록 조회

### 유저 시나리오
- 사용자는 상품 목록을 조회할 수 있다.
- 사용자는 특정 브랜드 필터 기능을 사용할 수 있다
- 사용자는 최신순, 가격순, 좋아요 순으로 정렬 할 수 있다. (디폴트 - 최신순)
- 사용자는 페이지, 페이지당 상품 수를 지정하여 상품 목록을 조회할 수 있다.

### 기능적 요구사항
- GET /api/v1/products 로 목록을 조회한다.
- 요청 파라미터
  - brandId(Optional) : 특정 브랜드의 상품만 필터링
  - sort : latest(기본), price_asc, likes_desc
  - page : 페이지 번호 (기본값 : 0)
    - 빈페이지 일 경우 성공, 빈화면 노출
  - size : 페이지당 상품 수(기본값 : 20)
- 에러처리

  | 조건            | HTTP  | message    |
  |---------------|---|-------------------|
  | 유효하지 않은 정렬 키  | 400 | 유효하지 않은 정렬 기준입니다. |
  | 비활성/미존재 브랜드   | 404 | 해당 브랜드를 찾을 수 없습니다 |

### 비기능적 요구사항
- **인덱스 설계**
  - `idx_products_brand_id`: 브랜드별 상품 필터링
  - `idx_products_created_at`: 최신순 정렬
  - `idx_products_price`: 가격순 정렬
  - `idx_products_total_likes`: 좋아요순 정렬
  - 복합 인덱스: `(brand_id, created_at)`, `(brand_id, price)`, `(brand_id, total_likes)` 고려
- **캐시 전략**
  - 상품 목록 조회 결과 Redis 캐시 적용
  - 캐시 키: `products:list:{brandId}:{sort}:{page}:{size}`
  - TTL: 5분 (상품 정보 변경 빈도 고려)

---
## 상품 상세 조회

### 유저 시나리오
- 사용자는 productId를 통해 상품 상세 정보를 확인할 수 있다.
- 사용자는 내가 해당 상품을 좋아요 했는지 여부를 확인할 수 있다.
- 사용자는 총 좋아요수를 확인 할수 있다.
- 사용자는 재고가 0일 경우 구매가 불가함을 인지할 수 있다.

### 기능적 요구사항
- GET /api/v1/products/{productId} 로 상세를 조회한다.
- 응답 파라미터
  - 상품 아이디, 브랜드 정보, 상품명, 설명, 가격, 재고, 총 좋아요 수
  - 좋아요 여부 : X-USER-ID가 있을 때만 포함(없으면 생략 또는 false)
- 제약사항
  -	productId 필수 없으면 404
  -	재고 0이면 "일시 품절" 상태(구매 불가) 안내
- 에러처리

  | 조건            | HTTP | message           |
  |---------------|-----|-------------------|
  | 비활성/미존재 상품 ID | 404 | 해당 상품을 찾을 수 없습니다. |

### 비기능적 요구사항
- **캐시 전략**
  - 상품 상세 정보 Redis 캐시 적용
  - 캐시 키: `product:detail:{productId}`
  - TTL: 10분
  - 무효화: 상품 정보 변경, 좋아요 등록/취소 시 캐시 삭제

---
## 브랜드 조회

### 유저 시나리오
- 사용자는 특정 브랜드의 기본 정보를 확인할 수 있다.
- 사용자는 해당 브랜드의 상품 목록을 조회할 수 있다.

### 기능적 요구사항
- GET /api/v1/brands/{brandId} 로 조회한다.
- 제약 사항
    - brandId 필수 없으면 404
- 에러처리

  | 조건                   | HTTP | message            |
  |----------------------|------|--------------------|
  | 비활성/미존재 브랜드 ID | 404 | 해당 브랜드를 찾을 수 없습니다. |


---
## 상품 좋아요 등록/취소 (멱등 동작)

### 유저 시나리오
- 로그인한 사용자만 좋아요 등록 및 취소할 수 있다.
- 사용자는 목록/상세에서 하트를 눌러 좋아요를 등록/취소할 수 있다.
- 좋아요 등록 요청이 여러번 와도 좋아요 등록 상태는 유지된다
- 좋아요 취소 요청이 여러번 와도 좋아요 취소 상태는 유지된다.

### 기능적 요구사항
- 등록: POST /api/v1/like/products/{productId}
- 취소: DELETE /api/v1/like/products/{productId}
- 제약사항
  - X-USER-ID 필수 없으면 404
  - productId 필수 없으면 404
  - 좋아요 동일 요청시에도 해당 상태를 유지한다.
- 에러처리

  | 조건                          | HTTP | message            |
  |-----------------------------|------|--------------------|
  | X-USER-ID 누락 or 유효하지 않는 사용자 | 404 | 해당 사용자를 찾을 수 없습니다. |
  | 비활성/미존재 상품 ID           | 404 | 해당 상품을 찾을 수 없습니다. |

### 비기능적 요구사항
- **비정규화**: Product 테이블에 `totalLikes` 필드 유지
  - 좋아요 등록 시: `Product.increaseLikes()` 호출
  - 좋아요 취소 시: `Product.decreaseLikes()` 호출
- **동시성 제어**: Product 엔티티에 `@Version` 낙관적 락 적용
  - 동일 상품에 대한 동시 좋아요 요청 시 정합성 보장
- **캐시 무효화**: 좋아요 등록/취소 시 해당 상품 캐시 삭제
  - `product:detail:{productId}` 캐시 evict
  - `products:list:*` 관련 캐시 evict (좋아요순 정렬 영향)

---
## 내가 좋아요 한 상품 목록 조회

### 유저 시나리오
- 로그인한 사용자는 좋아요한 목록을 볼 수 있다.

### 기능적 요구사항
- GET /api/v1/like/products
- 제약사항
  - X-USER-ID 필수 없으면 404
- 에러처리

  | 조건                          | HTTP | message            |
  |-----------------------------|------|--------------------|
  | X-USER-ID 누락 or 유효하지 않는 사용자 | 404 | 해당 사용자를 찾을 수 없습니다. |

### 비기능적 요구사항
- **인덱스**: `uk_product_like_user_product (user_id, product_id)` 유니크 인덱스 활용

---

## 주문 생성 및 결제 흐름 (재고 차감, 포인트 차감, 외부 시스템 연동)

### 유저 시나리오
- 사용자는 여러 상품을 한 번에 주문하고 보유 포인트로 결제할 수 있다.
- 재고 및 포인트가 있을 경우 주문할 수 있다.

### 기능적 요구사항
- POST /api/v1/orders 로 주문 생성
- 요청 본문 예시
```
{
  "items": [
    { "productId": 1, "quantity": 2 },
    { "productId": 3, "quantity": 1 }
  ],
  "idempotencyKey": "uuid-like string (optional)"
}
```
- 결제시 재고 확인후 차감, 포인트 확인 차감 후 주문 생성한다.
  - 하나라도 실패시 전체 롤백
- 재고 부족시 부족한 재고의 상품명을 알려준다.
- 제약사항
  - 하나 이상의 상품을 주문해야한다.
  - 상품 주문 정보는 외부 시스템에 전송 할수 있다.
- 에러처리

  | 조건            | HTTP | message                   |
    |---------------|------|---------------------------|
  | 비활성/미존재 상품 ID | 404  | 해당 상품을 찾을 수 없습니다.         |
  | 재고 부족         | 400  | {상품명} 상품의 재고가 부족합니다.      |
  | 포인트 부족        | 400  | 보유 포인트가 부족하여 결제 할 수 없습니다. |


---
## 주문 목록 조회

### 유저 시나리오
- 사용자는 내가 만든 주문 내역을 최신순으로 확인할 수 있다.

기능적 요구사항
- GET /api/v1/orders 로 목록을 조회한다.
- 제약사항
  - X-USER-ID 필수 없으면 404
- 에러처리

| 조건                          | HTTP | message            |
  |-----------------------------|------|--------------------|
| X-USER-ID 누락 or 유효하지 않는 사용자 | 404 | 해당 사용자를 찾을 수 없습니다. |

---
## 주문 단일 상세 조회

### 유저 시나리오
- 사용자는 특정 주문의 상세를 확인할 수 있다.

### 기능적 요구사항
- GET /api/v1/orders/{orderId}
- 제약사항
    - X-USER-ID 필수 없으면 404
- 에러처리

  | 조건                          | HTTP | message            |
  |-----------------------------|------|--------------------|
  | X-USER-ID 누락 or 유효하지 않는 사용자 | 404 | 해당 사용자를 찾을 수 없습니다. |

---

## 성능 최적화 전략 (Round 5)

### 인덱스 설계 원칙
1. **카디널리티가 높은 컬럼**에 인덱스 적용
2. **복합 인덱스**: WHERE 조건 + ORDER BY 순서 고려
3. **EXPLAIN** 분석으로 인덱스 사용 여부 확인

### 캐시 전략
| 대상 | 캐시 키 패턴 | TTL | 무효화 조건 |
|-----|------------|-----|----------|
| 상품 상세 | `product:detail:{id}` | 10분 | 상품 수정, 좋아요 변경 |
| 상품 목록 | `products:list:{params}` | 5분 | 상품 추가/수정/삭제 |

### 비정규화 전략
- **Product.totalLikes**: 좋아요 수 집계를 위한 JOIN 제거
- 동시성 제어: `@Version` 낙관적 락으로 정합성 보장
